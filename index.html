<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Print Client</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .hidden {
            display: none !important;
        }

        .printer-card {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .printer-info h3 {
            margin: 0 0 5px 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .printer-meta {
            display: flex;
            gap: 10px;
            font-size: 0.85rem;
            color: #64748b;
            align-items: center;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-driver {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-network {
            background: #fae8ff;
            color: #86198f;
        }

        .badge-bt {
            background: #ffedd5;
            color: #9a3412;
        }

        .badge-default {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .actions-row {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .scan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .scan-item {
            border: 1px dashed #cbd5e1;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scan-item:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #334155;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }
    </style>
</head>

<body id="app-body">
    <div class="container">
        <header style="flex-direction: column; align-items: flex-start; gap: 10px;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                <h1>UniversalPOS Print Client</h1>
                <div id="status-container" class="status-offline">
                    <span id="status-indicator">‚óè</span>
                    <span id="status-text">Desconectado</span>
                </div>
            </div>

            <div class="server-config"
                style="display: flex; gap: 10px; width: 100%; background: #f1f5f9; padding: 10px; border-radius: 6px; box-sizing: border-box; align-items: center; flex-wrap: wrap;">
                <label for="server-url" style="font-weight: 600; font-size: 0.9rem; color: #475569;">Agente URL:</label>
                <input type="text" id="server-url" value="http://localhost:5050" placeholder="http://ip:port"
                    style="flex: 1; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; min-width: 150px;">
                <button onclick="conectarAgent()" class="primary-btn btn-sm">Conectar</button>
                <div id="mobile-start-container"
                    style="display: none; border-left: 1px solid #cbd5e1; padding-left: 10px;">
                    <button onclick="iniciarAgenteMovil()" class="secondary-btn btn-sm"
                        style="background-color: #f59e0b; color: white;">‚ö° Iniciar Agente</button>
                </div>
            </div>

            <div id="bridge-config-container" class="hidden"
                style="margin-top: 10px; width: 100%; background: #eff6ff; padding: 10px; border-radius: 6px; border: 1px solid #bfdbfe; box-sizing: border-box; align-items: center; flex-wrap: wrap; gap: 10px;">
                <label for="bridge-url" style="font-weight: 600; font-size: 0.9rem; color: #1e40af;">üîó Modo
                    Puente:</label>
                <input type="text" id="bridge-url" placeholder="URL Nodo Maestro (http://ip:port)"
                    style="flex: 1; padding: 6px; border: 1px solid #bfdbfe; border-radius: 4px; min-width: 150px;">
                <button id="btn-bridge" class="primary-btn btn-sm"
                    style="background-color: #2563eb; color: white;">Activar</button>
                <span id="bridge-status-badge"
                    style="display:none; font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-weight: bold; border: 1px solid #86efac;">EN
                    PUENTE</span>
            </div>
        </header>

        <!-- Management Section -->
        <section class="config-section">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h2>Gesti√≥n de Impresoras</h2>
                    <button onclick="toggleSection('printer-management-content', this)" class="secondary-btn btn-sm"
                        style="padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.8rem;">‚ñº</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="listarImpresoras()" class="secondary-btn btn-sm">üîÑ Actualizar</button>
                    <button onclick="mostrarModalRegistro()" class="secondary-btn btn-sm">‚ûï Agregar Manual</button>
                    <button onclick="iniciarEscaneo()" class="secondary-btn btn-sm">üîç Escanear</button>
                </div>
            </div>

            <div id="printer-management-content">
                <!-- Scan Area (Mobile) -->
                <div id="scan-area" class="hidden"
                    style="margin-bottom: 20px; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                    <h4 style="margin-top:0; color:#475569;">Escanear Dispositivos</h4>
                    <div style="display:flex; justify-content: flex-end; margin-bottom:10px;">
                        <button onclick="toggleScan()"
                            style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold;">Cerrar
                            ‚úñ</button>
                    </div>
                    <div id="scan-status" style="margin:5px 0; font-style:italic; font-size:0.85rem; color:#64748b;">
                    </div>
                    <div id="scan-results" class="scan-grid"></div>
                </div>

                <!-- Printer List -->
                <div id="printer-list-container">
                    <div style="text-align: center; padding: 20px; color: #64748b;">Cargando lista de impresoras...
                    </div>
                </div>
            </div>
        </section>

        <!-- Printing & Preview Section -->
        <!-- Merged Content & Print Section -->
        <div
            style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <!-- Header -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin:0; color: #1e293b; font-size: 1.2rem;">Contenido del Ticket</h3>
                <div style="display: flex; gap: 8px;">
                    <button id="btn-toggle-json" onclick="toggleCustomJsonVisibility()" class="secondary-btn btn-sm">üëÅÔ∏è
                        Mostrar JSON</button>
                    <button onclick="generarVistaPrevia()" class="secondary-btn btn-sm"
                        style="background-color: #64748b; color: white;">üëÅÔ∏è Vista Previa</button>
                </div>
            </div>

            <!-- Custom JSON Container -->
            <div id="custom-json-container" class="hidden" style="margin-bottom: 20px;">
                <label for="custom-json-text"
                    style="display:block; margin-bottom:5px; font-size:0.85rem; color:#64748b;">Edite el JSON para
                    personalizar la impresi√≥n:</label>
                <textarea id="custom-json-text" rows="15"
                    style="width: 100%; border: 1px solid #cbd5e1; border-radius: 6px; font-family: monospace; padding: 8px; box-sizing: border-box;"></textarea>
            </div>

            <!-- Preview Container -->
            <div id="preview-container" class="hidden"
                style="margin-bottom: 20px; background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong style="color: #334155;">Vista Previa:</strong>
                    <button onclick="document.getElementById('preview-container').classList.add('hidden')"
                        style="background:none; border:none; cursor:pointer; font-size: 1.2rem; color: #64748b;">√ó</button>
                </div>
                <div id="preview-image-placeholder" style="overflow: auto; text-align: center;"></div>
            </div>

            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 20px 0;">

            <!-- Print Actions -->
            <div>
                <div
                    style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <!-- Status Column -->
                    <div id="printer-status-text" style="flex: 1; min-width: 200px;">
                        <span style="color: #64748b; font-size: 0.9rem;">‚ÑπÔ∏è Se usar√° la impresora predeterminada.</span>
                    </div>

                    <!-- Selector (injected in row when toggled) -->
                    <div id="printer-selection-container" class="hidden" style="flex: 1; min-width: 200px;">
                        <select id="printer-select"
                            style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9rem;">
                            <option value="">Predeterminada</option>
                        </select>
                    </div>

                    <!-- Buttons Column -->
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="togglePrinterSelection()" class="secondary-btn btn-sm"
                            style="font-size: 0.8rem; height: 38px;" title="Cambiar impresora">‚öôÔ∏è Cambiar</button>
                        <button onclick="ejecutarImpresion()" class="primary-btn"
                            style="height: 38px; padding: 0 20px; background-color: var(--primary-color); color: white; font-size: 0.95rem; font-weight: bold; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">üñ®Ô∏è
                            IMPRIMIR TICKET</button>
                    </div>
                </div>
            </div>
        </div>

        <section class="log-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Log de Eventos</h3>
                <button onclick="document.getElementById('log-output').innerHTML=''"
                    style="background:none; border:none; color:#64748b; cursor:pointer; font-size:0.8rem;">Limpiar</button>
            </div>
            <div id="log-output"></div>
        </section>
    </div>

    <!-- Modular Scripts -->
    <script type="module" src="/modules/init.js"></script>

    <!-- Modal Registro -->
    <div id="modal-registro" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0">Nueva Impresora</h3>
            <div class="form-group">
                <label>Nombre / Alias</label>
                <input type="text" id="reg-name" placeholder="Ej. Cocina_Principal">
            </div>
            <div class="form-group">
                <label>Tipo de Conexi√≥n</label>
                <select id="reg-type">
                    <option value="NETWORK">Red (Ethernet/WiFi)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Objetivo (IP o MAC)</label>
                <input type="text" id="reg-address" placeholder="Ej. 192.168.1.50">
                <small style="color:#64748b; font-size:0.75rem;">IP para Red, MAC (AA:BB:CC...) para Bluetooth</small>
            </div>
            <div class="form-group" style="display:flex; gap:10px; margin-bottom:0;">
                <button onclick="guardarImpresora()" class="primary-btn" style="flex:1;">Guardar</button>
                <button onclick="cerrarModal()" class="secondary-btn" style="flex:1;">Cancelar</button>
            </div>
        </div>
    </div>
</body>

</html>