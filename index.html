<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Print Client</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body id="app-body">
    <div class="container">
        <header style="flex-direction: column; align-items: flex-start; gap: 10px;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                <h1>Administrador de Agente POS LWP</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="status-container" class="status-offline">
                        <span id="status-indicator">‚óè</span>
                        <span id="status-text">Desconectado</span>
                    </div>
                    <button id="btn-settings" onclick="toggleConnectionSettings()" class="secondary-btn btn-sm"
                        style="background: #e2e8f0; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        ‚öôÔ∏è <span class="hide-mobile">Ajustes</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Connection Settings Modal -->
        <div id="connection-overlay" class="modal-overlay">
            <div id="connection-settings-container" class="modal-content">
                <h3 style="margin-top: 0;">‚öôÔ∏è Configuraci√≥n de Conexi√≥n</h3>
                <div class="window-content" style="padding: 0;">
                    <div class="server-config"
                        style="display: flex; flex-direction: column; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 6px; box-sizing: border-box;">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label for="server-url" style="font-weight: 600; font-size: 0.9rem; color: #475569;">Agente
                                URL:</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="server-url" value="http://localhost:5050"
                                    placeholder="http://ip:port"
                                    style="flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
                                <button id="btn-retry-connect" onclick="conectarAgent()"
                                    class="primary-btn btn-sm hidden"
                                    style="background-color: #ef4444; color: white;">Reintentar</button>
                            </div>
                        </div>

                        <div id="mobile-start-container"
                            style="display: none; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                            <button onclick="iniciarAgenteMovil()" class="secondary-btn"
                                style="background-color: #f59e0b; color: white; width: 100%;">‚ö° Iniciar Agente
                                Local</button>
                        </div>

                        <div id="bridge-config-container"
                            style="border-top: 1px solid #e2e8f0; padding-top: 10px; display: flex; flex-direction: column; gap: 10px; position: relative;">

                            <!-- Overlay for Offline State -->
                            <div id="bridge-offline-overlay" class="bridge-overlay hidden">
                                <div class="bridge-overlay-message">
                                    <p>Agente desconectado</p>
                                    <small>Funcionalidad no disponible</small>
                                </div>
                            </div>

                            <label for="bridge-url" style="font-weight: 600; font-size: 0.9rem; color: #1e40af;">üîó Modo
                                Puente:</label>

                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="bridge-url" placeholder="URL Nodo Maestro (http://ip:port)"
                                    style="flex: 1; padding: 8px; border: 1px solid #bfdbfe; border-radius: 4px;">
                                <button id="btn-bridge" class="primary-btn btn-sm"
                                    style="background-color: #2563eb; color: white;">Activar</button>
                            </div>
                            <span id="bridge-status-badge"
                                style="display:none; text-align: center; font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-weight: bold; border: 1px solid #86efac;">EN
                                PUENTE</span>
                        </div>
                        <div style="margin-top: 5px; text-align: center; display: flex; gap: 10px;">
                            <button onclick="toggleConnectionSettings()" class="secondary-btn"
                                style="flex: 1; padding: 10px;">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="main-content-grid">
            <!-- Management Section -->
            <section class="config-section">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: nowrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h3 style="margin:0; color: #1e293b; font-size: 1.2rem;">Dispositivos e Impresoras</h3>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-refresh-printers" title="Escanear conexiones de tipo BLE/USB"
                            onclick="listarImpresoras()" class="secondary-btn btn-sm">üîÑ</button>
                        <button onclick="mostrarModalRegistro()" class="secondary-btn btn-sm">‚ûï Agregar por IP</button>
                        <button id="btn-scan-network" title="Escanear conexiones de tipo Network"
                            onclick="iniciarEscaneo()" class="secondary-btn btn-sm">üîç
                            Escanear Red</button>
                    </div>
                </div>

                <div id="printer-management-content"
                    style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                    <!-- Scan Area (Mobile) -->
                    <div id="scan-area" class="hidden"
                        style="margin-bottom: 20px; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                        <div
                            style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
                            <h4 style="margin:0; color:#475569;">Escanear Dispositivos</h4>
                            <button onclick="toggleScan()"
                                style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:bold; padding: 0;">Cerrar
                                ‚úñ</button>
                        </div>
                        <div id="scan-status"
                            style="margin:5px 0; font-style:italic; font-size:0.85rem; color:#64748b;">
                        </div>
                        <div id="scan-results" class="scan-grid"></div>
                    </div>

                    <!-- Printer List -->
                    <div id="printer-list-container" class="vertical-device-list sub-section-box" style="flex: 1;">
                        <div
                            style="background: white; padding: 20px; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; box-sizing: border-box; border: 1px solid #cbd5e1; color: #64748b;">
                            <p style="margin: 0; font-weight: bold;">‚è≥ Cargando...</p>
                            <p style="margin: 5px 0 0 0; font-size: 0.8rem;">Inicializando sistema.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Printing & Preview Section -->
            <!-- Merged Content & Print Section -->
            <div class="config-section">
                <!-- Header -->
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: nowrap; gap: 10px;">
                    <h3 style="margin:0; color: #1e293b; font-size: 1.2rem;">Ticket de Prueba</h3>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-toggle-json" onclick="toggleCustomJsonVisibility()"
                            class="secondary-btn btn-sm">üîß
                            Editar JSON</button>
                        <button id="btn-refresh-preview" onclick="generarVistaPrevia()" class="secondary-btn btn-sm"
                            style="background-color: #64748b; color: white;">üîÑ</button>
                    </div>
                </div>

                <!-- Custom JSON Container -->
                <div id="custom-json-container" class="hidden floating-window">
                    <div class="window-header" id="json-window-header">
                        <h4>üîß Editor de JSON</h4>
                        <button onclick="toggleCustomJsonVisibility()" class="btn-close-window">√ó</button>
                    </div>
                    <div class="window-content">
                        <label for="custom-json-text"
                            style="display:block; margin-bottom:10px; font-size:0.85rem; color:#64748b;">Edite el JSON
                            para personalizar la impresi√≥n:</label>
                        <textarea id="custom-json-text" rows="15"
                            style="width: 100%; border: 1px solid #cbd5e1; border-radius: 6px; font-family: monospace; padding: 10px; box-sizing: border-box; resize: both;"></textarea>
                    </div>
                </div>

                <div id="preview-container" class="hidden sub-section-box"
                    style="margin-bottom: 10px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">

                    <div id="preview-image-placeholder" class="preview-limited"
                        style="overflow-x: auto; text-align: center; padding: 10px; flex: 1;"></div>
                </div>

                <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 10px 0;">

                <!-- Print Actions -->
                <div>
                    <div
                        style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <!-- Status Column -->
                        <div id="printer-status-text" style="flex: 1;">
                            <span style="color: #64748b; font-size: 0.9rem;">‚ÑπÔ∏è Se usar√° la impresora
                                predeterminada.</span>
                        </div>

                        <!-- Selector (injected in row when toggled) -->
                        <div id="printer-selection-container" class="hidden" style="flex: 1; min-width: 200px;">
                            <select id="printer-select"
                                style="width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9rem;">
                                <option value="">Predeterminada</option>
                            </select>
                        </div>

                        <!-- Buttons Column -->
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="togglePrinterSelection()" class="secondary-btn btn-sm"
                                style="font-size: 0.8rem; height: 38px;" title="Cambiar impresora">‚öôÔ∏è
                                Cambiar</button>
                            <button onclick="ejecutarImpresion()" class="primary-btn"
                                style="height: 38px; padding: 0 20px; background-color: var(--primary-color); color: white; font-size: 0.95rem; font-weight: bold; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">üñ®Ô∏è
                                IMPRIMIR</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Modular Scripts -->
    <script type="module" src="/modules/init.js"></script>

    <!-- Modal Registro -->
    <div id="modal-registro" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0">‚ûï Nueva Impresora</h3>
            <div class="form-group">
                <label>Nombre / Alias</label>
                <input type="text" id="reg-name" placeholder="Ej. Cocina_Principal">
            </div>
            <div class="form-group">
                <label>Objetivo (IP o MAC)</label>
                <input type="text" id="reg-address" placeholder="Ej. 192.168.1.50">
            </div>
            <div class="form-group" style="display:flex; gap:10px; margin-bottom:0;">
                <button onclick="cerrarModal()" class="secondary-btn" style="flex:1;">Cancelar</button>
                <button onclick="guardarImpresora()" class="primary-btn" style="flex:1;">Guardar</button>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div id="toast-container"></div>
</body>

</html>